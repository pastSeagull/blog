<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>useEffect&amp;useState | Gaviota</title>
<link rel="stylesheet" href="https://pastSeagull.github.io/blog//css/style.css">



<link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/monokai.min.css" rel="stylesheet">





<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://pastSeagull.github.io/blog/"><h1 class="title is-4">Gaviota</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/pastSeagull">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/pastSeagull">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="subtitle is-6">September 7, 2022</h2>
    <h1 class="title">useEffect&amp;useState</h1>
    <div class="content">
      <p>接口返回时间不确定，当第二次接口返回的数据比第一次快的时候，
可能也就一些大数据量的特定接口会出现这些问题。</p>
<p>某个业务代码，大概就是类似于select or tab切换的场景中，当你第二次点击接口的返回数据比第一次快的时候。</p>
<p>看下面代码，这时候我们先点击<code>2</code>在点击<code>1</code>，这时候因为2数据返回会比较慢，这时候数据就不对了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useEffect</span>, <span style="color:#a6e22e">useState</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;react&#39;</span>

<span style="color:#a6e22e">type</span> <span style="color:#a6e22e">Type</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">string</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">textPromise</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Type</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Type</span><span style="color:#f92672">&gt;</span> =&gt; {
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">delay</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;2&#39;</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">2000</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">200</span>
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">reject</span>, <span style="color:#a6e22e">resolve</span>) =&gt; {
    <span style="color:#a6e22e">setTimeout</span>(() =&gt; {
      <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">value</span>)
    }, <span style="color:#a6e22e">delay</span>)
  })
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">App</span>() {
  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">setData</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Type</span><span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">null</span>)
  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">setValue</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Type</span><span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#34;1&#34;</span>)

  <span style="color:#a6e22e">useEffect</span>(() =&gt; {
    <span style="color:#a6e22e">setData</span>(<span style="color:#66d9ef">null</span>)
    <span style="color:#a6e22e">textPromise</span>(<span style="color:#a6e22e">value</span>).<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">res</span>) =&gt; {
      <span style="color:#a6e22e">setData</span>(<span style="color:#a6e22e">res</span>)
    })
  }, [<span style="color:#a6e22e">value</span>])

  <span style="color:#66d9ef">return</span> (
    <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">div</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">button</span> <span style="color:#a6e22e">onClick</span><span style="color:#f92672">=</span>{() =&gt; <span style="color:#a6e22e">setValue</span>(<span style="color:#e6db74">&#34;1&#34;</span>)}<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/button&gt;</span>
      <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">button</span> <span style="color:#a6e22e">onClick</span><span style="color:#f92672">=</span>{() =&gt; <span style="color:#a6e22e">setValue</span>(<span style="color:#e6db74">&#34;2&#34;</span>)}<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">2</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/button&gt;</span>
      <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">button</span> <span style="color:#a6e22e">onClick</span><span style="color:#f92672">=</span>{() =&gt; <span style="color:#a6e22e">setValue</span>(<span style="color:#e6db74">&#34;3&#34;</span>)}<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">3</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/button&gt;</span>
      <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">br</span> <span style="color:#f92672">/&gt;</span>
      {<span style="color:#a6e22e">data</span> <span style="color:#f92672">??</span> <span style="color:#e6db74">&#39;loading&#39;</span>}
    <span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/div&gt;</span>
  )
}
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">App</span>
</code></pre></div><p>这时候大佬这样写，大概就是点击的时候记录开始和结束时间，然后用ref来更新值。
在<code>deps</code>用了<code>ref</code>作为依赖，但是<code>ref</code>没有<code>dispatcher</code>的，<code>ref</code>的更新也不会<code>render</code></p>
<p>经过整理后大概是这样，实际上真正起作用的是<code>setValue</code>，水管图.jpg。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">App</span>() {
  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">setValue</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Type</span><span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">null</span>)
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">startTimeRef</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useRef</span>(<span style="color:#ae81ff">0</span>)

  <span style="color:#a6e22e">useEffect</span>(() =&gt; {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;useEffect&#39;</span>, <span style="color:#a6e22e">startTimeRef</span>.<span style="color:#a6e22e">current</span>)
  }, [<span style="color:#a6e22e">startTimeRef</span>.<span style="color:#a6e22e">current</span>])

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">changeValue</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>) =&gt; {
    <span style="color:#a6e22e">startTimeRef</span>.<span style="color:#a6e22e">current</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">getTime</span>()
    <span style="color:#a6e22e">setValue</span>(<span style="color:#a6e22e">value</span>)
  }

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">printRef</span> <span style="color:#f92672">=</span> () =&gt; {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">startTimeRef</span>.<span style="color:#a6e22e">current</span>)
  }

  <span style="color:#66d9ef">return</span> (
    <span style="color:#f92672">&lt;&gt;</span>
      <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">button</span> <span style="color:#a6e22e">onClick</span><span style="color:#f92672">=</span>{() =&gt; <span style="color:#a6e22e">changeValue</span>(<span style="color:#e6db74">&#34;1&#34;</span>)}<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/button&gt;</span>
      <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">button</span> <span style="color:#a6e22e">onClick</span><span style="color:#f92672">=</span>{() =&gt; <span style="color:#a6e22e">changeValue</span>(<span style="color:#e6db74">&#34;2&#34;</span>)}<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">2</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/button&gt;</span>
      <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">button</span> <span style="color:#a6e22e">onClick</span><span style="color:#f92672">=</span>{() =&gt; <span style="color:#a6e22e">changeValue</span>(<span style="color:#e6db74">&#34;3&#34;</span>)}<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">3</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/button&gt;</span>
      <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">br</span> <span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">button</span> <span style="color:#a6e22e">onClick</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">printRef</span>}<span style="color:#f92672">&gt;</span><span style="color:#a6e22e">print</span> <span style="color:#a6e22e">ref</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/button&gt;</span>
    <span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/&gt;</span>
  )
}
</code></pre></div><p><code>abortController</code>，但是兼容性不太好
<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController/AbortController">https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController/AbortController</a></p>
<p>大概就是塞个额外判定的条件判断ui的state和接口的state是对得上的</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">useEffect</span>(() =&gt; {
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">canceled</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
  <span style="color:#a6e22e">setData</span>(<span style="color:#66d9ef">null</span>)
  <span style="color:#a6e22e">textPromise</span>(<span style="color:#a6e22e">value</span>).<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">res</span>) =&gt; {
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">canceled</span>) <span style="color:#66d9ef">return</span>
      <span style="color:#a6e22e">setData</span>(<span style="color:#a6e22e">res</span>)
  })
  <span style="color:#66d9ef">return</span> () =&gt; { <span style="color:#a6e22e">canceled</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> }
}, [<span style="color:#a6e22e">value</span>])
</code></pre></div><p>vue也差不多，在select这种场景也可能会遇到这种问题。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">script</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ts&#34;</span> <span style="color:#a6e22e">setup</span><span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">ref</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;vue&#39;</span>

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ref</span>(<span style="color:#e6db74">&#39;&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ref</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Type</span><span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">null</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> [
  {
    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;1&#39;</span>,
    <span style="color:#a6e22e">label</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;1&#39;</span>,
  },
  {
    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2&#39;</span>,
    <span style="color:#a6e22e">label</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2&#39;</span>,
  },
  {
    <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;3&#39;</span>,
    <span style="color:#a6e22e">label</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;3&#39;</span>,
  }
]
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">changeSelect</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">val</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>) =&gt; {
  <span style="color:#a6e22e">textPromise</span>(<span style="color:#a6e22e">val</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">res</span> =&gt; {
    <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">res</span>
  })
} 

<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/script&gt;</span>
<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">template</span><span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">div</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">el</span><span style="color:#f92672">-</span><span style="color:#a6e22e">select</span> <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">change</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;changeSelect&#34;</span> <span style="color:#a6e22e">v</span><span style="color:#f92672">-</span><span style="color:#a6e22e">model</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value&#34;</span> <span style="color:#66d9ef">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;m-2&#34;</span> <span style="color:#a6e22e">placeholder</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Select&#34;</span> <span style="color:#a6e22e">size</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;large&#34;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">el</span><span style="color:#f92672">-</span><span style="color:#a6e22e">option</span> <span style="color:#a6e22e">v</span><span style="color:#f92672">-</span><span style="color:#66d9ef">for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;item in options&#34;</span> <span style="color:#f92672">:</span><span style="color:#a6e22e">key</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;item.value&#34;</span> <span style="color:#f92672">:</span><span style="color:#a6e22e">label</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;item.label&#34;</span> <span style="color:#f92672">:</span><span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;item.value&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/el-select&gt;</span>
    <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">br</span> <span style="color:#f92672">/&gt;</span>
    {{<span style="color:#a6e22e">data</span>}}
  <span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/div&gt;</span>
<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/template&gt;</span>
</code></pre></div><p>当然你可以设置<code>disabled</code>，第一次数据没返回就禁用</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">changeSelect</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">val</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>) =&gt; {
  <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>
  <span style="color:#a6e22e">disabledSelect</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
  <span style="color:#a6e22e">textPromise</span>(<span style="color:#a6e22e">val</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">res</span> =&gt; {
    <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">res</span>
  }).<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span> =&gt; {}).<span style="color:#66d9ef">finally</span>(() =&gt; {
    <span style="color:#a6e22e">disabledSelect</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
  })
}
</code></pre></div><h2 id="参考">参考</h2>
<hr>
<ol>
<li><a href="https://beta-reactjs-org-git-effects-fbopensource.vercel.app/">React Docs BETA</a></li>
</ol>
    </div>
  </div>
</section>

<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/pastSeagull">Gaviota</a> 2016</p>
  </div>
</section>







<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>







<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>






